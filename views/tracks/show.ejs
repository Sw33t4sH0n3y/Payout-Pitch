<%- include('../partials/header') %>

<main class="page-container">
    <a href="/tracks" class="back-link">‚Üê Back to Songs</a>

    <div class="track-header">
        <div class="track-header-info">
            <h1><%= track.title %></h1>
            <div class="track-meta">
                <span class="status-badge status-<%= track.status %>"><%= track.status %></span>
                <% if (track.releaseDate) { %>
                <span>üìÖ <%= track.releaseDate %></span>
        <% } %>
        <% if (track.isrc) { %>
            <span>üîñ <%= track.isrc %></span>
        <% } %>
            </div>
        </div>

        <div class="track-actions">
            <a href="/tracks/<%= track._id%>/edit" class="btn btn-secondary">‚úèÔ∏è Edit</a>
        </div>
    </div>
        <div class="track-content">
            <section class="collaborators-section">
                <div class="section-header">
                    <h2>üë• Collaborators</h2>
                    <a href="/tracks/<%= track._id %>/collaborators/new" class="btn btn-small btn-secondary">+ Add</a>
                </div>
              
                <div class="collab-card owner-card">
                    <div class="collab-avatar owner-avatar">
                        <%= user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U' %>
                    </div>
                    <div class="collab-info">
                        <div class="collab-name">
                            <%= user.displayName %>
                            <span class="owner-badge">üëë Owner</span>
                        </div>
                        <div class="collab-roles">
                            <% if (user.roles && user.roles.length > 0) { %>
                            <% user.roles.forEach(role => { %>
                            <span class="role-badge role-badge-<%= role %>">
                                <%= ROLES[role].icon %> <%= ROLES[role].label %>
                            </span>
                          <% }) %>
                        <% } else { %>
                            <span class="no-roles">No set roles</span>
                            <% } %>
                        </div>
                    </div>
                </div>

                <% if (! track.collaborators || track.collaborators.length === 0) { %>
                <div class="empty-collabs">
                    <p>No collaborators yet</p>
                    <a href="/tracks/<%= track._id %>/collaborators/new">Add collaborator</a>
                </div>
               <% } else { %>
            <% track.collaborators.forEach(collab => { %>
            <div class="collab-card">
                <div class="collab-avatar">
                    <%= collab.name.charAt(0).toUpperCase() %>
                </div>
                <div class="collab-info">
                    <div class="collab-name"><%= collab.name %></div>
                    <div class="collab-roles">
                        <% collab.roles.forEach(role => { %>
                        <span class="role-badge role-badge-<%= role %>">
                            <%= ROLES[role].icon %> <%= ROLES[role].label %>
                        </span>
                       <% }) %>
                    </div>
                </div>
            <div class="collab-actions">
                <a href="/tracks/<%= track._id %>/collaborators/<%= collab._id %>/edit" class="btn-icon">‚úèÔ∏è</a>
                <form action="/tracks/<%= track._id %>/collaborators/<%= collab._id %>?_method=DELETE" method="POST">
                    <button type="submit" class="btn-icon" onclick="return confirm('Remove this collaborator?')">üóëÔ∏è</button>
                </form>
            </div>
        </div>    
        <% }) %>
    <% } %>
</section>

<section class="splits-section">
    <h2>üìä Ownership Splits</h2>

    <form action="/tracks/<%= track._id %>/splits?_method=PUT" method="POST">

        <div class="card splits-card">
        <div class="splits-header">
            <h3>üéµ Masters</h3>
            <span class="splits-total">
                <%= track.splits && track.splits.master ? track.splits.master.user : 100 %>%</span>
        </div>
        <div class="splits-list">
            <div class="split-item">
                <div class="user-avatar split-avatar">You</div>
                <div class="split-name"><%= user.displayName %></div>
                <div class="split-input-group">
                    <input type="number" name="masterOwner" value="<%= track.splits && track.splits.master ? track.splits.master.user : 100 %>" min="0" max="100" class="split-input">
                    <span>%</span>
                </div>
            </div>
            <% if (track.collaborators) { %>
            <% track.collaborators.forEach(collab => { %>
            <% const collabID = collab._id.toString(); %>
            <% const masterPct = track.splits && track.splits.master && track.splits.master.collaborators ? (track.splits.master.collaborators.get(collabId) || 0) :0; %>
            <div class="split-item">
                <div class="user-avatar split-avatar"><%= collab.name.charAt(0).toUpperCase() %></div>
                <div class="split-input-group">
                    <input type="number" name="master_<%=collabId %>" value="<%= masterPct %>" min="0" max="100" class="split-input">
                    <span>%</span>
                </div>
            </div>
           <% }) %>
           <% } %>
        </div>    
    </div>

    <div class="card splits-card">
        <div class="splits-header">
            <h3>üìù Publishing</h3>
            <span class="splits-total">
                <%= track.splits && track.splits.publishing ? track.splits.publishing.user : 100 %>%
            </span>
        </div>

        <div class="splits-list">
            <div class="split-item">
            <div class="user-avatar split-avatar">You</div>
            <div class="split-name"><%= user.displayName %></div>
            <div class="split-input-group">
                <input type="number" name="publishingOwner" value="<%= track.splits && track.splits.publishing ? track.splits.publishing.user : 100 %>" min="0" max="100" class="split-input">
                <span>%</span>
            </div>    
        </div>

        <% if (track.collaborators) { %>
        <% track.collaborators.forEach(collab => { %> 
        <% const collabId = collab._id.toString(); %>
        <% const publishingPct = track.splits && track.splits.publishing && track.splits.publishing.collaborators ? (track.splits.publishing.collaborators.get(collabId) || 0) : 0; %>
        <div class="split-item">
            <div class="user-avatar split-avatar"><%= collab.name.charAt(0).toUpperCase() %></div>
            <div class="split-name"><%= collab.name %></div>
            <div class="split-input-group">
                <input type="number" name="publishing_<%= collabId %>" value="<%= publishingPct %>" min="0" max="100" class="split-input">
                <span>%</span>
            </div>
        </div>
        <% }) %>
        <% } %>    
    </div>
</div>

 <button type="submit" class="btn btn-primary btn-full">üíæ Make it Official</button>
</form>
</section>
        </div>
         <div class="danger-zone">
            <h3>Danger Zone</h3>
            <form action="/tracks/<%= track._id %>?_method=DELETE" method="POST">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Delete this song? Are you sure? Last and final offer.')">üóëÔ∏è Delete Song</button>
            </form>
    </div>
</main>

<%- include('../partials/footer') %>